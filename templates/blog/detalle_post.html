{% extends 'base.html' %}
{% load static %}

{% block title %}{{ post.titulo }} - Paddle Challenge{% endblock %}

{% block content %}
<div class="container mt-4" style="max-width:950px;">
  <div class="mb-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
    <div>
      <a href="{% url 'blog:lista_posts' %}" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-left me-1"></i>Volver</a>
      <a href="{% url 'blog:categoria' post.categoria.slug %}" class="btn btn-outline-primary btn-sm"><i class="fas fa-tag me-1"></i>{{ post.categoria.nombre }}</a>
    </div>
    <div class="text-muted small">
      <i class="fas fa-calendar me-1"></i>{{ post.fecha_publicacion|date:'d M Y' }} · <i class="fas fa-eye ms-2 me-1"></i>{{ post.visualizaciones }}
    </div>
  </div>
  
  <article class="card border-0 shadow-sm mb-4">
    {% if post.imagen_destacada %}
      <img src="{{ post.imagen_destacada.url }}" class="card-img-top" alt="{{ post.titulo }}" style="max-height:360px;object-fit:cover;">
    {% endif %}
    <div class="card-body">
      <h1 class="h3 mb-3">{{ post.titulo }}</h1>
      <p class="text-muted small mb-4">Escrito por {{ post.autor.get_full_name|default:post.autor.username }}</p>
      <div class="mb-4" style="line-height:1.6;">{{ post.contenido|linebreaks }}</div>
      
      {% if user.is_authenticated %}
        {% if user.is_staff %}
          <div class="d-flex gap-2">
            <a href="{% url 'blog:editar_post' post.slug %}" class="btn btn-outline-secondary btn-sm"><i class="fas fa-edit me-1"></i>Editar</a>
            <a href="{% url 'blog:eliminar_post' post.slug %}" class="btn btn-outline-danger btn-sm"><i class="fas fa-trash me-1"></i>Eliminar</a>
          </div>
        {% elif user.pk == post.autor_id %}
          <div class="d-flex gap-2">
            <a href="{% url 'blog:editar_post' post.slug %}" class="btn btn-outline-secondary btn-sm"><i class="fas fa-edit me-1"></i>Editar</a>
            <a href="{% url 'blog:eliminar_post' post.slug %}" class="btn btn-outline-danger btn-sm"><i class="fas fa-trash me-1"></i>Eliminar</a>
          </div>
        {% endif %}
      {% endif %}
    </div>
  </article>

  <section class="mb-5">
    <h2 class="h5 mb-3"><i class="fas fa-comments me-2"></i>Comentarios ({{ comentarios|length }})</h2>
    {% if comentarios %}
      <div class="list-group mb-3">
        {% for c in comentarios %}
          <div class="list-group-item">
            <div class="d-flex justify-content-between small mb-1">
              <strong>{{ c.autor.username }}</strong>
              <span class="text-muted">{{ c.fecha_creacion|date:'d M Y H:i' }}</span>
            </div>
            <div>{{ c.contenido|linebreaks }}</div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted">No hay comentarios todavía.</p>
    {% endif %}

    {% if user.is_authenticated %}
      <form method="post" class="card border-0 shadow-sm">
        <div class="card-body">
          {% csrf_token %}
          {{ comentario_form.contenido.label_tag }}
          {{ comentario_form.contenido }}
        </div>
        <div class="card-footer bg-light text-end">
          <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-paper-plane me-1"></i>Comentar</button>
        </div>
      </form>
    {% else %}
      <p><a href="{% url 'login' %}">Inicia sesión</a> para comentar.</p>
    {% endif %}
  </section>

  {% if posts_relacionados %}
    <section class="mb-4">
      <h2 class="h6 mb-3 text-muted"><i class="fas fa-link me-2"></i>Relacionados</h2>
      <div class="row">
        {% for rp in posts_relacionados %}
          <div class="col-md-4 mb-3">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <h5 class="card-title h6"><a href="{% url 'blog:detalle_post' rp.slug %}" class="text-decoration-none">{{ rp.titulo|truncatechars:40 }}</a></h5>
                <small class="text-muted">{{ rp.fecha_publicacion|date:'d M Y' }}</small>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </section>
  {% endif %}
</div>
{% endblock %}